{% extends 'dreams/base.html' %}

{% block title %}心理健康分析{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="page-header">
        <div class="dream-icon">
            <i class="fas fa-heartbeat"></i>
        </div>
        <h1>夢境心理診斷</h1>
        <p class="text-muted">分析您的夢境並獲取心理健康建議</p>
    </div>

    <!-- 選擇夢境 -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title">選擇夢境進行分析</h5>
        </div>
        <div class="card-body">
            <form method="POST">
                {% csrf_token %}
                <label for="dream_id" class="form-label">選擇夢境：</label>
                <select name="dream_id" class="form-select" required>
                    {% for dream in dreams %}
                        <option value="{{ dream.id }}">{{ dream.created_at|date:"Y-m-d H:i" }} - {{ dream.dream_content|truncatechars:30 }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary mt-3">分析心理健康</button>
            </form>
        </div>
    </div>

    <!-- 顯示選擇的夢境 -->
    {% if selected_dream %}
    <div class="card mt-4">
        <div class="card-header">
            <h5><i class="fas fa-moon me-2"></i> 夢境內容</h5>
        </div>
        <div class="card-body">
            <p>{{ selected_dream.dream_content }}</p>
        </div>
    </div>

    <!-- 顯示夢境解析結果 -->
    <div class="card mt-4">
        <div class="card-header">
            <h5><i class="fas fa-brain me-2"></i> 解析結果</h5>
        </div>
        <div class="card-body">
            <p>{{ selected_dream.interpretation|linebreaks }}</p>
        </div>
    </div>

    <!-- 顯示 AI 夢境情緒警報 -->
    <div class="modal fade" id="emotionAlertModal" tabindex="-1" aria-labelledby="emotionAlertLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="emotionAlertLabel">⚠️ AI 情緒警報</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
                </div>
                <div class="modal-body">
                    {{ emotion_alert|safe }}
                </div>
                <div class="modal-footer d-flex justify-content-center w-100">
                    <button type="button" class="btn btn-outline-danger btn-sm" data-bs-dismiss="modal">我知道了</button>
                </div>                    
            </div>
        </div>
    </div>

    <!-- 顯示 AI 產生的心理健康建議 -->
    <div class="card mt-4">
        <div class="card-header bg-success text-white">
            <h5><i class="fas fa-heartbeat"></i> 心理健康建議</h5>
        </div>
        <div class="card-body">
            <p>{{ mental_health_advice }}</p>
        </div>
    </div>

    <!-- ✅ 新增：與心理師聊天按鈕 -->
    {% if therapist %}
    <div class="text-center mt-4">
        <a href="{% url 'chat_with_therapist' therapist.id %}" class="btn btn-outline-primary btn-lg">
            <i class="fas fa-comments me-2"></i>與心理師聊天
        </a>
    </div>
    {% endif %}
    {% endif %}  <!-- 對應 selected_dream 結尾 -->

    <!-- 分享夢境給心理師表單 -->
    <form method="POST" action="{% url 'share_dreams' %}">
        {% csrf_token %}
        <label>選擇你想分享給的心理師：</label>
        <select name="therapist_id" class="form-select mb-2">
            {% for t in therapists %}
                <option value="{{ t.id }}">{{ t.username }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary">分享夢境給心理師</button>
    </form>

    <!-- 新增安全的聊天室連結（判斷 therapists 不為空） -->
    {% if therapists %}
    <div class="mt-3">
        <a href="{% url 'chat_with_therapist' therapists.0.id %}" class="btn btn-success">
            進入聊天室
        </a>
    </div>
    {% endif %}

    <div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">

        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}

        <div class="card shadow-lg rounded-4 border-0">
            <div class="card-body p-4">
            <h3 class="card-title text-center mb-4">
                <i class="fas fa-hand-holding-heart me-2 text-primary"></i>分享夢境並預約心理會談
            </h3>

            <form method="POST" action="{% url 'share_and_schedule' %}">
                {% csrf_token %}

                <!-- 選擇心理師 -->
                <div class="mb-3">
                <label for="therapist" class="form-label fw-bold">選擇心理師</label>
                <select class="form-select" name="therapist_id" required>
                    <option value="">請選擇心理師</option>
                    {% for t in therapists %}
                    <option value="{{ t.id }}">{{ t.username }}{% if t.userprofile.specialty %}（{{ t.userprofile.specialty }}）{% endif %}</option>
                    {% endfor %}
                </select>
                </div>

                <!-- 選擇時間 -->
                <div class="mb-3">
                <label for="scheduled_time" class="form-label fw-bold">預約時間</label>
                <input type="datetime-local" class="form-control" name="scheduled_time" required>
                <div class="form-text text-muted">
                    系統將自動避免時間衝突，請選擇您方便的時段。
                </div>
                </div>

                <!-- 傳送訊息 -->
                <div class="mb-3">
                <label for="message" class="form-label fw-bold">留言給心理師</label>
                <textarea class="form-control" name="message" rows="3" placeholder="可以簡單說明您想討論的困擾、情緒或夢境背景……"></textarea>
                </div>

                <!-- 提交按鈕 -->
                <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary btn-lg rounded-pill px-5">
                    <i class="fas fa-paper-plane me-2"></i>送出預約與分享
                </button>
                </div>
            </form>

            </div>
        </div>

        </div>
    </div>
    </div>

</div>

<style>
    .card .card-body i {
        color: var(--primary-color); /* 確保圖標顏色與主題一致 */
    }
    /* 确保 Modal 在页面中央显示 */
    .modal-dialog {
        position: fixed;
        top: -41.4%;
        left: 32%;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        {% if emotion_alert %}
        const modalElement = document.getElementById('emotionAlertModal');
        const modal = new bootstrap.Modal(modalElement, {
            backdrop: false,
            keyboard: false
        });
        setTimeout(function () {
            modal.show();
        }, 500);
        {% endif %}
    });

    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.card');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animation-fade-in');
                    observer.unobserve(entry.target);
                }
            });
        });
        cards.forEach(card => observer.observe(card));
    });
</script>
{% endblock %}
