{% extends 'dreams/base.html' %}
{% block title %}管理貼文{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="card shadow rounded-4">
    <!-- Header -->
    <div class="card-header btn-primary text-white d-flex justify-content-between align-items-center px-4 py-3 ">
      <h4 class="mb-0">
        <i class="fas fa-edit me-2"></i>貼文管理
      </h4>
      <form method="get" class="mb-0" style="max-width: 400px; width: 100%;">
        <div class="input-group">
          <input type="text" name="q" class="form-control me-2" placeholder="搜尋標題、內容或用戶" value="{{ query }}">
          <button class="btn btn-light btn-sm" type="submit">
            <i class="fas fa-search me-1"></i>
          </button>
        </div>
      </form>
    </div>

    <!-- 表格區塊 -->
    <div class="card-body table-responsive p-0">
      <table class="table table-hover align-middle mb-0 text-center">
        <thead class="table-secondary small text-nowrap">
          <tr>
            <th class="px-3 py-2" style="width: 10%;">用戶</th>
            <th class="px-3 py-2" style="width: 15%;">標題</th>
            <th class="px-3 py-2" style="width: 8%;">匿名</th>
            <th class="px-3 py-2" style="width: 25%;">內容摘要</th>
            <th class="px-3 py-2" style="width: 8%;">瀏覽次數</th>
            <th class="px-3 py-2" style="width: 16%;">建立時間</th>
            <th class="px-3 py-2" style="width: 10%;">狀態</th>
            <th class="px-3 py-2" style="width: 10%;">操作</th>
          </tr>
        </thead>
        <tbody class="small">
          {% for post in posts %}
          <tr>
            <td class="px-3 py-2 align-middle">
              {% if post.is_anonymous %}
                <span class="text-muted"><i class="fas fa-user-secret"></i> 匿名</span>
              {% elif post.user %}
                {{ post.user.username }}
              {% else %}
                無
              {% endif %}
            </td>
            <td class="px-3 py-2 " style="white-space: nowrap;">{{ post.title }}</td>
            <td class="px-3 py-2 align-middle">
              {% if post.is_anonymous %}
                <span class="badge bg-secondary">匿名</span>
              {% else %}
                <span class="badge bg-success">公開</span>
              {% endif %}
            </td>
            <td class="px-3 py-2 ">{{ post.content|truncatechars:30 }}</td>
            <td class="px-3 py-2 align-middle">{{ post.view_count }}</td>
            <td class="px-3 py-2 align-middle">{{ post.created_at|date:"Y-m-d H:i" }}</td>
            <td class="px-3 py-2 align-middle">
              {% if post.is_flagged %}
                <span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>不當用詞</span>
              {% else %}
                <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>正常</span>
              {% endif %}
            </td>
            <td class="px-3 py-2 align-middle">
              <a href="{% url 'toggle_flag_post' post.id %}" class="btn btn-sm btn-outline-warning rounded-3 mb-1" title="標記/取消標記">
                <i class="fas fa-flag"></i>
              </a>
              <a href="{% url 'delete_post' post.id %}" class="btn btn-sm btn-outline-danger rounded-3 mb-1" onclick="return confirm('確定要刪除這篇貼文？')" title="刪除">
                <i class="fas fa-trash-alt"></i>
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted py-4">目前尚無貼文資料</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- 分頁 -->
    <div class="card-footer bg-light">
      {% if posts.has_other_pages %}
      <nav>
        <ul class="pagination justify-content-center mb-0">
          {% if posts.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ posts.previous_page_number }}{% if query %}&q={{ query }}{% endif %}">上一頁</a>
            </li>
          {% endif %}
          <li class="page-item disabled">
            <span class="page-link">第 {{ posts.number }} / 共 {{ posts.paginator.num_pages }} 頁</span>
          </li>
          {% if posts.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ posts.next_page_number }}{% if query %}&q={{ query }}{% endif %}">下一頁</a>
            </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
