import React, { useState, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend } from 'recharts';
import { Cloud } from 'lucide-react';

const MentalHealthDashboard = () => {
  const [emotionTrends, setEmotionTrends] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchEmotionTrends = async () => {
      try {
        // 使用 fetch 替代 axios
        const response = await fetch('/api/dream-emotions', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            // 如果需要認證，加入 Authorization header
            // 'Authorization': `Bearer ${yourAuthToken}`
          }
        });

        if (!response.ok) {
          throw new Error('網絡響應錯誤');
        }

        const data = await response.json();
        
        // 處理 API 返回的數據
        const processedData = data.map(dream => ({
          date: dream.date,
          焦慮: dream.emotions.anxiety || 0,
          壓力: dream.emotions.stress || 0,
          快樂: dream.emotions.happiness || 0,
          悲傷: dream.emotions.sadness || 0,
          興奮: dream.emotions.excitement || 0
        }));

        setEmotionTrends(processedData);
        setLoading(false);
      } catch (err) {
        console.error("獲取夢境情緒數據時出錯:", err);
        setError('無法獲取夢境情緒數據');
        setLoading(false);
      }
    };

    fetchEmotionTrends();
  }, []);

  // 模擬數據，當實際 API 未就緒時使用
  const mockEmotionTrends = [
    { date: '2024-03-20', 焦慮: 65, 壓力: 55, 快樂: 35, 悲傷: 30, 興奮: 20 },
    { date: '2024-03-21', 焦慮: 70, 壓力: 60, 快樂: 30, 悲傷: 35, 興奮: 15 },
    { date: '2024-03-22', 焦慮: 75, 壓力: 65, 快樂: 25, 悲傷: 40, 興奮: 10 },
    { date: '2024-03-23', 焦慮: 80, 壓力: 70, 快樂: 20, 悲傷: 45, 興奮: 5 }
  ];

  // 如果 API 調用失敗，使用模擬數據
  const displayData = emotionTrends.length > 0 ? emotionTrends : mockEmotionTrends;

  if (loading) {
    return <div className="text-center mt-5">載入中...</div>;
  }

  return (
    <div className="container mt-5">
      <h1 className="text-center mb-4">夢境情緒趨勢分析</h1>

      <div className="row">
        <div className="col-12">
          <div className="card">
            <div className="card-header">
              <h3>夢境情緒指數追蹤</h3>
            </div>
            <div className="card-body">
              <LineChart width={900} height={400} data={displayData}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="date" />
                <YAxis />
                <Tooltip />
                <Legend />
                <Line type="monotone" dataKey="焦慮" stroke="#FF6384" />
                <Line type="monotone" dataKey="壓力" stroke="#36A2EB" />
                <Line type="monotone" dataKey="快樂" stroke="#4CAF50" />
                <Line type="monotone" dataKey="悲傷" stroke="#9C27B0" />
                <Line type="monotone" dataKey="興奮" stroke="#FF9800" />
              </LineChart>
            </div>
          </div>
        </div>
      </div>

      {/* AI 情緒洞察 */}
      <div className="row mt-4">
        <div className="col-12">
          <div className="card">
            <div className="card-header">
              <h3>AI 夢境情緒洞察</h3>
            </div>
            <div className="card-body">
              <div 
                className="alert" 
                style={{ backgroundColor: 'rgba(106, 90, 205, 0.1)' }}
              >
                <Cloud className="me-2" color="#6a5acd" />
                {displayData.length > 0 && (
                  <>
                    根據最近的夢境分析，您的
                    <strong>焦慮指數上升了 
                      {((displayData[displayData.length-1].焦慮 - 
                        displayData[0].焦慮) / displayData[0].焦慮 * 100).toFixed(1)}%
                    </strong>
                    。建議關注心理健康，必要時尋求專業協助。
                  </>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default MentalHealthDashboard;