{% extends 'dreams/base.html' %}
{% block title %}æˆ‘çš„å¿ƒç†å¸«{% endblock %}

{% block content %}
<div class="container mt-5">

  <!-- ğŸ’Œ å¿ƒç†å¸«èŠå¤©å®¤é‚€è«‹å€å¡Š -->
  {% if chat_invitations %}
    <div class="card mb-4 shadow rounded border border-purple-300">
      <div class="card-header bg-gradient-to-r from-purple-300 to-purple-400 text-white font-bold py-3 px-4 rounded-top d-flex align-items-center">
        <i class="fas fa-envelope-open-text me-2"></i>å¿ƒç†å¸«èŠå¤©å®¤é‚€è«‹
      </div>
      <div class="card-body bg-white px-4 py-3">
        {% for invite in chat_invitations %}
          <div class="p-3 mb-3 border rounded-lg shadow-sm bg-purple-50 d-flex justify-content-between align-items-center flex-wrap">
            <div class="flex-grow-1 me-3">
              <p class="mb-1 text-gray-800 fw-semibold">
                <i class="fas fa-user-md text-primary me-2"></i>
                {{ invite.therapist.get_full_name|default:invite.therapist.username }}
              </p>
              <small class="text-muted">
                é‚€è«‹æ–¼ {{ invite.created_at|timesince }} å‰ç™¼å‡º
              </small>
            </div>

            <div class="d-flex align-items-center flex-wrap gap-2">
              {% if invite.status == 'pending' %}
                <!-- åŸæœ¬çš„æ¥å—æ‹’çµ•æŒ‰éˆ•è¡¨å–® -->
                <form action="{% url 'respond_invitation' invite.id %}" method="post" class="d-flex gap-2 m-0">
                  {% csrf_token %}
                  <button name="action" value="accept" type="submit" class="btn btn-sm btn-success d-flex align-items-center gap-1">
                    <i class="fas fa-check"></i> æ¥å—
                  </button>
                  <button name="action" value="reject" type="submit" class="btn btn-sm btn-danger d-flex align-items-center gap-1">
                    <i class="fas fa-times"></i> æ‹’çµ•
                  </button>
                </form>

              {% elif invite.status == 'accepted' %}
                <span class="badge bg-success d-flex align-items-center gap-1">
                  <i class="fas fa-check-circle"></i> å·²æ¥å—
                </span>
                <!-- åˆªé™¤é‚€è«‹è¨˜éŒ„æŒ‰éˆ• -->
                <form action="{% url 'delete_invitation' invite.id %}" method="post" class="d-inline ms-2" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é‚€è«‹è¨˜éŒ„å—ï¼Ÿ');">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger d-flex align-items-center gap-1">
                    <i class="fas fa-trash-alt"></i> åˆªé™¤è¨˜éŒ„
                  </button>
                </form>

              {% elif invite.status == 'rejected' %}
                <span class="badge bg-secondary d-flex align-items-center gap-1">
                  <i class="fas fa-ban"></i> å·²æ‹’çµ•
                </span>
                <!-- åˆªé™¤é‚€è«‹è¨˜éŒ„æŒ‰éˆ• -->
                <form action="{% url 'delete_invitation' invite.id %}" method="post" class="d-inline ms-2" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é‚€è«‹è¨˜éŒ„å—ï¼Ÿ');">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger d-flex align-items-center gap-1">
                    <i class="fas fa-trash-alt"></i> åˆªé™¤è¨˜éŒ„
                  </button>
                </form>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <p class="text-muted">ç›®å‰æ²’æœ‰èŠå¤©å®¤é‚€è«‹ã€‚</p>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <h3 class="mb-4">ğŸ§  æ‚¨å·²åˆ†äº«å¤¢å¢ƒçš„å¿ƒç†å¸«</h3>
    <!-- ğŸ‘¨â€âš•ï¸ å¿ƒç†å¸«æ¸…å–® -->
    {% if therapist_statuses %}
      <div class="row">
        {% for ts in therapist_statuses %}
          {% with therapist=ts.therapist %}
          <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0 rounded-4">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <h5 class="card-title mb-1">
                    <i class="fas fa-user-md text-primary me-2"></i>{{ therapist.username }}
                  </h5>
                  {% if therapist.userprofile.specialty %}
                    <p class="card-text text-muted mb-0">å°ˆé•·ï¼š{{ therapist.userprofile.specialty }}</p>
                  {% endif %}
                  {% if therapist.id in confirmed_therapist_ids %}
                    <span class="badge bg-success mt-2">âœ… å·²é ç´„ç¢ºèª</span>
                  {% endif %}
                </div>
                <div>
                  {% if ts.is_active %}
                    <a href="{% url 'chat_with_user' user_id=ts.therapist.id %}" class="btn btn-outline-primary me-2"><!-- #æ›´æ”¹ -->
                      é€²å…¥èŠå¤©å®¤
                    </a>
                    <form method="post" action="{% url 'cancel_share' therapist.id %}" style="display:inline;" onsubmit="return confirm('ç¢ºå®šè¦å–æ¶ˆåˆ†äº«å—ï¼Ÿ');">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline-danger">
                        å–æ¶ˆåˆ†äº«
                      </button>
                    </form>
                  {% else %}
                    <button class="btn btn-outline-secondary" disabled>å·²å–æ¶ˆåˆ†äº«</button>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">æ‚¨å°šæœªåˆ†äº«å¤¢å¢ƒçµ¦ä»»ä½•å¿ƒç†å¸«ã€‚</p>
    {% endif %}
</div>
{% endblock %}