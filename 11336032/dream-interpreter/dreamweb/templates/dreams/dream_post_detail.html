{% extends 'dreams/base.html' %}
{% load static %} {# 加載 static 檔案，用於頭像圖片 #}

{% block title %} - 夢境詳情{% endblock %}

{% block content %}
<style>
    /* Custom styles for main post content truncation */
    .post-content-truncated {
        font-size: 1.1rem;
        line-height: 1.8;
        white-space: pre-wrap; /* 保留換行 */
        color: var(--text-dark);
    }

    /* Comment like button specific styles, aligning with community style */
    .comment-card .like-button {
        border-radius: 20px; /* 保持圓角 */
        transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }

    /* BEGIN MODIFICATION: Enhanced CSS for btn-danger state (已按讚) */
    .comment-card .like-button.btn-danger {
        background-color: var(--heart-color) !important; /* 強制背景色為心形紅色 */
        border-color: var(--heart-color) !important;     /* 強制邊框色為心形紅色 */
        color: white !important;                         /* 強制文字顏色為白色 */
    }
    .comment-card .like-button.btn-danger i {
        color: white !important;                         /* 強制愛心圖標為白色 */
    }
    /* END MODIFICATION */

    .comment-card .like-button.btn-outline-danger { /* 未按讚 (空心灰) */
        background-color: transparent !important; /* 確保透明背景 */
        color: #888 !important; /* 文字顏色為灰色 */
        border-color: #ccc !important; /* 邊框顏色為灰色 */
    }
    .comment-card .like-button.btn-outline-danger i {
        color: #888 !important; /* 愛心圖標為灰色 */
    }
    .comment-card .like-button:hover {
        opacity: 0.8;
    }

    /* 其他 Dcard 風格相關的通用樣式 */
    .post-header-info { text-align: center; }
    .post-header-info h1 { font-size: 2.2rem; font-weight: bold; line-height: 1.3; }
    .post-header-info img, .post-header-info i { margin-right: 0 !important; margin-bottom: 5px; }
    .post-header-info .badge { font-size: 0.75rem; }
</style>

<div class="container mt-5">
    {# Page Header and Post Info #}
    <div class="page-header text-center mb-4">
        <h1 class="mb-3">{{ dream.title }}</h1>

        <div class="post-header-info d-flex flex-column align-items-center mb-3">
            {% if dream.is_anonymous %}
                <i class="fas fa-user-secret fa-4x text-muted mb-2"></i>
                <div><strong class="text-muted">匿名發佈</strong></div>
            {% else %}
                {% if dream.user.userprofile.avatar %}
                    <img src="{{ dream.user.userprofile.avatar.url }}" alt="{{ dream.user.username }}"
                         class="rounded-circle mb-2" style="width: 80px; height: 80px; object-fit: cover; border: 2px solid var(--primary-color);">
                {% else %}
                    <img src="https://ui-avatars.com/api/?name={{ dream.user.username }}&background=0D8ABC&color=fff&size=80"
                         alt="{{ dream.user.username }}"
                         class="rounded-circle mb-2" style="width: 80px; height: 80px; object-fit: cover; border: 2px solid var(--primary-color);">
                {% endif %}
                <div class="text-center">
                    <h5 class="mb-1">{{ dream.user.username }}</h5>
                    {% if dream.user.userprofile.current_title %}
                        <span class="badge bg-info me-1">{{ dream.user.userprofile.current_title }}</span>
                    {% endif %}
                    {% if dream.user.userprofile.current_badge_icon %}
                        <i class="{{ dream.user.userprofile.current_badge_icon }} text-warning ms-1"></i>
                    {% endif %}
                </div>
            {% endif %}
            <p class="text-muted mt-3">
                <i class="far fa-eye me-1"></i> 瀏覽次數：{{ dream.view_count }}
                <span class="mx-2">|</span>
                <i class="far fa-calendar-alt me-1"></i> 發布日期：{{ dream.created_at|date:"Y-m-d H:i" }}
            </p>

            {% if request.user == dream.user %}
                <div class="post-actions mt-3 d-flex justify-content-center">
                    <a href="{% url 'edit_dream_post' post_id=dream.id %}" class="btn btn-outline-primary me-2 px-4">
                        <i class="fas fa-edit me-1"></i>編輯貼文
                    </a>
                    <form action="{% url 'delete_dream_post' post_id=dream.id %}" method="post" style="display:inline;" onsubmit="return confirm('您確定要刪除這篇貼文嗎？這個操作無法撤回。');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger px-4">
                            <i class="fas fa-trash-alt me-1"></i>刪除貼文
                        </button>
                    </form>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        {# 左側導覽列 #}
        <nav class="col-md-3">
            <div class="list-group mb-4 dream-nav shadow-sm rounded overflow-hidden">
                <a href="{% url 'dream_community' %}" class="list-group-item list-group-item-action d-flex align-items-center py-3 border-0 transition">
                    <i class="fas fa-comments me-3 nav-icon"></i>
                <span class="fw-medium">夢境社群</span>
                </a>
                <a href="{% url 'my_posts' %}" class="list-group-item list-group-item-action d-flex align-items-center py-3 border-0 transition">
                    <i class="fa-solid fa-pen-to-square me-3 nav-icon"></i>
                <span class="fw-medium">我的夢境貼文</span>
                </a>
                <a href="{% url 'share_dream' %}" class="list-group-item list-group-item-action d-flex align-items-center py-3 border-0 transition">
                    <i class="fas fa-share-alt me-3 nav-icon"></i>
                <span class="fw-medium">分享夢境</span>
                </a>
                <a href="{% url 'search_dreams' %}" class="list-group-item list-group-item-action d-flex align-items-center py-3 border-0 transition">
                    <i class="fas fa-search me-3 nav-icon"></i>
                <span class="fw-medium">搜尋夢境</span>
                </a>
                <a class="list-group-item list-group-item-action card-header d-flex align-items-center py-3 border-0 transition">
                    <i class="fa-solid fa-floppy-disk me-3 nav-icon"></i>
                <span class="fw-medium">目前貼文</span>
                </a>
            </div>
        </nav>

        <main class="col-md-6">
            {# 夢境內容 #}
            <div class="card p-4 mb-4">
                <h3 class="card-title mb-3"><i class="fas fa-moon me-2"></i>夢境內容</h3>
                <div class="post-content-body border p-3 rounded bg-light post-content-truncated">
                    {{ dream.content|linebreaksbr }} {# Typically, dream detail content is not truncated #}
                </div>
            </div>

            {# 評論區 #}
            <div class="card p-4 comments-section">
                <h3 class="card-title mb-3"><i class="fas fa-comments me-2"></i>評論區 ({{ comments|length }})</h3>
                <ul class="comment-list list-unstyled">
                    {% for comment in comments %}
                        <li class="mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %} comment-card">
                            <div class="d-flex align-items-start">
                                {% if comment.user.userprofile.avatar %}
                                    <img src="{{ comment.user.userprofile.avatar.url }}" alt="{{ comment.user.username }}" class="rounded-circle me-3" style="width: 35px; height: 35px; object-fit: cover;">
                                {% else %}
                                    <img src="https://ui-avatars.com/api/?name={{ comment.user.username }}&background=random&color=fff&size=35" alt="{{ comment.user.username }}" class="rounded-circle me-3">
                                {% endif %}
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <div>
                                            <strong class="d-block">{{ comment.user.username }}</strong>
                                            <small class="text-muted">{{ comment.created_at|date:"Y-m-d H:i" }}</small>
                                        </div>
                                        {# 按讚功能區塊 #}
                                        <div class="text-nowrap">
                                            {% if user.is_authenticated %}
                                                {# BEGIN MODIFICATION: Button color logic now uses btn-danger based on image_f1a711.png #}
                                                <button type="button" class="btn btn-sm {% if comment.is_liked_by_user %}btn-danger{% else %}btn-outline-danger{% endif %} like-button" data-comment-id="{{ comment.id }}" style="border-radius: 20px;">
                                                    <i class="fas fa-heart me-1"></i> <span class="like-count">{{ comment.likes_count }}</span>
                                                </button>
                                                {# END MODIFICATION #}
                                            {% else %}
                                                <span class="text-muted"><i class="fas fa-heart me-1"></i> <span class="like-count">{{ comment.likes_count }}</span></span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <p class="mb-0 comment-text" style="font-size: 1rem; line-height: 1.6;">{{ comment.content }}</p>
                                </div>
                            </div>
                        </li>
                    {% empty %}
                        <p class="text-muted text-center py-3">目前沒有評論，快來發表第一條評論吧！</p>
                    {% endfor %}
                </ul>

                {% if user.is_authenticated %}
                    <form method="POST" class="mt-4 comment-form">
                        {% csrf_token %}
                        <textarea name="comment" class="form-control mb-2" rows="4" placeholder="發表評論..."></textarea>
                        <button type="submit" class="btn btn-primary">提交評論</button>
                    </form>
                {% else %}
                    <p class="mt-4 text-center">請先<a href="{% url 'login' %}">登入</a>以發表評論。</p>
                {% endif %}
            </div>
        </main>

        {# 右側相似夢境推薦區塊 #}
        <aside class="col-md-3">
            <div class="card p-4 mb-4">
                <h3 class="card-title mb-3"><i class="fas fa-search me-2"></i>相似夢境推薦：</h3>
                <ul class="list-unstyled mt-3">
                    {% for similar_dream in similar_dreams %}
                        <li class="mb-3">
                            <div class="card p-3 shadow-sm bg-light">
                                <h5 class="mb-2">
                                    <a href="{% url 'dream_post_detail' post_id=similar_dream.id %}" class="text-decoration-none text-primary">
                                        {{ similar_dream.title }}
                                    </a>
                                </h5>
                                <p class="text-muted mb-0" style="font-size: 0.9rem;">{{ similar_dream.content|striptags|truncatewords:8 }}</p>
                            </div>
                        </li>
                    {% empty %}
                        <p class="text-muted">沒有相似夢境推薦。</p>
                    {% endfor %}
                </ul>
            </div>
        </aside>
    </div>
</div>

{# JavaScript for Comment Like Button #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const likeButtons = document.querySelectorAll('.like-button');

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[[i]].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        likeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const commentId = this.dataset.commentId;
                const url = `/comment/${commentId}/like_toggle/`;
                const buttonElement = this;
                const likeCountSpan = buttonElement.querySelector('.like-count');

                if (!csrftoken) {
                    console.error('CSRF token not found. Cannot send like request.');
                    alert('安全驗證失敗，請刷新頁面再試。');
                    return;
                }

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            alert('請先登入才能按讚或取消按讚！');
                            window.location.href = '{% url "login" %}?next=' + window.location.pathname;
                            return;
                        }
                        throw new Error(`HTTP error! Status: ${response.status} - ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        likeCountSpan.textContent = data.likes_count;
                        // BEGIN MODIFICATION: Ensure correct class switching for btn-danger/btn-outline-danger
                        if (data.liked) {
                            buttonElement.classList.remove('btn-outline-danger');
                            buttonElement.classList.add('btn-danger');
                        } else {
                            buttonElement.classList.remove('btn-danger');
                            buttonElement.classList.add('btn-outline-danger');
                        }
                        // END MODIFICATION
                    } else {
                        alert('操作失敗: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('按讚操作時發生錯誤。請檢查網路連線或伺服器日誌。');
                });
            });
        });
    });
</script>

{% endblock %}