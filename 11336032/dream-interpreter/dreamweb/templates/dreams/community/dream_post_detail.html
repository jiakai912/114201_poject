<!-- 貼文詳情 -->
{% extends 'dreams/base.html' %}
{% load static %} {# 加載 static 檔案，用於頭像圖片 #}
{% load custom_filters %} {# 確保加載 custom_filters 以使用 safe_json_dumps #}

{% block title %} - 夢境貼文{% endblock %}

{% block content %}

<div class="container mt-5">
  <div class="row">
        <!-- 側邊欄 -->
        <nav class="col-md-3">
        <div class="list-group mb-4 dream-nav shadow-sm rounded overflow-hidden">
            <a href="{% url 'dream_community' %}" class="list-group-item list-group-item-action d-flex align-items-center py-3 border-0 transition">
            <i class="fas fa-comments me-3 nav-icon"></i><span class="fw-medium">夢境社群</span>
            </a>
            <a href="{% url 'my_posts' %}" class="list-group-item list-group-item-action d-flex align-items-center py-3 border-0 transition">
            <i class="fa-solid fa-pen-to-square me-3 nav-icon"></i><span class="fw-medium">我的夢境貼文</span>
            </a>
            <a href="{% url 'share_dream' %}" class="list-group-item list-group-item-action d-flex align-items-center py-3 border-0 transition">
            <i class="fas fa-share-alt me-3 nav-icon"></i><span class="fw-medium">分享夢境</span>
            </a>
            <a href="{% url 'search_dreams' %}" class="list-group-item list-group-item-action d-flex align-items-center py-3 border-0 transition">
            <i class="fas fa-search me-3 nav-icon"></i><span class="fw-medium">搜尋夢境</span>
            </a>
            <a class="list-group-item list-group-item-action card-header d-flex align-items-center py-3 border-0 transition">
            <i class="fa-solid fa-floppy-disk me-3 nav-icon"></i><span class="fw-medium">目前貼文</span>
            </a>
        </div>
        </nav>

        <div class="col-md-9">
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex align-items-center">
                        <!-- 頭像區塊 -->
                        {% if dream.is_anonymous %}
                            <div class="rounded-circle me-3 d-flex justify-content-center align-items-center shadow"
                                style="width: 50px; height: 50px; background-color: #6c757d; color: white; font-weight: bold; font-size: 14px; border: 2px solid #dee2e6;">
                                匿名
                            </div>
                            <h5 class="mb-0 text-white">匿名使用者</h5>
                        {% else %}
                            <!-- 頭像與名稱包在 a 標籤，支援浮動視窗 -->
                            <a href="{% url 'profile_view_other' dream.user.id %}"
                            class="user-popover-trigger d-flex align-items-center text-decoration-none"
                            data-user-id="{{ dream.user.id }}"
                            data-username="{{ dream.user.username }}"
                            data-avatar-url="{% if dream.user.userprofile.avatar %}{{ dream.user.userprofile.avatar.url }}{% else %}{% static 'images/default_avatar.png' %}{% endif %}"
                            data-display-title="{{ dream.author_display_title|default_if_none:'' }}"
                            data-display-badge-icon="{{ dream.author_display_badge_icon|default_if_none:'' }}"
                            data-bio="{{ dream.user.userprofile.bio|default_if_none:'' }}"
                            data-specialties="{{ dream.user.userprofile.specialties|default_if_none:'' }}"
                            >
                                {% if dream.user.userprofile.avatar %}
                                    <img src="{{ dream.user.userprofile.avatar.url }}" alt="{{ dream.user.username }}"
                                        class="rounded-circle me-3 shadow"
                                        style="width: 50px; height: 50px; object-fit: cover; border: 2px solid #dee2e6;">
                                {% else %}
                                    <div class="rounded-circle me-3 d-flex justify-content-center align-items-center shadow"
                                        style="width: 50px; height: 50px; background: linear-gradient(135deg, #b790f5, #55b1fc); color: white; font-weight: 600; font-size: 18px; border: 2px solid #dee2e6;">
                                        {{ dream.user.username|slice:":1"|upper }}
                                    </div>
                                {% endif %}
                                <div class="d-flex align-items-center">
                                    <h5 class="mb-0 text-white">{{ dream.user.username }}</h5>
                                    {% if dream.author_display_badge_icon %}
                                        <i class="{{ dream.author_display_badge_icon }} display-badge" style="color: white; margin-left: 8px;" title="展示徽章"></i>
                                    {% endif %}
                                </div>
                            </a>
                        {% endif %}


                        <!-- 發文時間 -->
                        <small class="text-white-50 ms-auto">{{ dream.created_at|date:"Y-m-d H:i" }}</small>
                    </div>
                </div>


                <div class="card-body">
                    <h2 class="card-title mb-3">{{ dream.title }}</h2>
                    <p class="card-text">{{ dream.content|linebreaksbr }}</p>
                    <div class="mb-3">
                        {% for tag in dream.tags.all %}
                            <span class="badge bg-secondary me-1">{{ tag.name }}</span>
                        {% endfor %}
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="me-3"><i class="fas fa-eye me-1"></i>{{ dream.view_count }}</span>
                            <span class="me-3">
                                <a href="#" class="text-decoration-none {% if dream.is_liked_by_user %}text-danger{% else %}text-muted{% endif %}" onclick="event.preventDefault(); togglePostLike({{ dream.id }});">
                                    <i class="fas fa-heart me-1"></i><span id="post-likes-count-{{ dream.id }}">{{ dream.likes.count }}</span>
                                </a>
                            </span>
                            <span><i class="fas fa-comment me-1"></i>{{ dream.comments.count }}</span>
                        </div>
                        {% if user.is_authenticated and user == dream.user or dream.is_anonymous and not dream.user %}
                            <div>
                                <a href="{% url 'edit_dream_post' dream.id %}" class="btn btn-outline-primary btn-sm me-2">編輯</a>
                                <form action="{% url 'delete_dream_post' dream.id %}" method="post" class="d-inline" onsubmit="return confirm('確定要刪除這篇貼文嗎？');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-danger btn-sm">刪除</button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>評論 ({{ dream.comments.count }})</h5>
                        </div>
                        <div class="card-body">
                            {% if comments %}
                            {% for comment in comments %}
                                <div class="d-flex mb-3 align-items-start">

                                    <!-- 名稱、徽章與內容 -->
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-1">
                                            <a href="{% url 'profile_view_other' comment.user.id %}" 
                                            class="user-popover-trigger d-flex align-items-center text-decoration-none text-dark"
                                            data-user-id="{{ comment.user.id }}"
                                            data-username="{{ comment.user.username }}"
                                            data-avatar-url="{% if comment.user.userprofile.avatar %}{{ comment.user.userprofile.avatar.url }}{% else %}{% static 'images/default_avatar.png' %}{% endif %}"
                                            data-display-title="{{ comment.commenter_display_title|default_if_none:'' }}"
                                            data-display-badge-icon="{{ comment.commenter_display_badge_icon|default_if_none:'' }}"
                                            data-bio="{{ comment.user.userprofile.bio|default_if_none:'' }}"
                                            data-specialties="{{ comment.user.userprofile.specialties|default_if_none:'' }}"
                                            >
                                                {% if comment.user.userprofile.avatar %}
                                                    <img src="{{ comment.user.userprofile.avatar.url }}" alt="{{ comment.user.username }}"
                                                        class="rounded-circle shadow me-2"
                                                        style="width: 40px; height: 40px; object-fit: cover; border: 2px solid #dee2e6;">
                                                {% else %}
                                                    <div class="rounded-circle d-flex justify-content-center align-items-center shadow me-2"
                                                        style="width: 40px; height: 40px; background: linear-gradient(135deg, #b790f5, #55b1fc); color: white; font-weight: 600; font-size: 16px; border: 2px solid #dee2e6;">
                                                        {{ comment.user.username|slice:":1"|upper }}
                                                    </div>
                                                {% endif %}
                                                <h6 class="mb-0">{{ comment.user.username }}</h6>
                                            </a>

                                            {% if comment.commenter_display_badge_icon %}
                                                <i class="{{ comment.commenter_display_badge_icon }} display-badge ms-2" title="展示徽章"></i>
                                            {% endif %}
                                        </div>

                                        <p class="mb-1">{{ comment.content|linebreaksbr }}</p>
                                        <small class="text-muted">{{ comment.created_at|date:"Y-m-d H:i" }}</small>
                                        <span class="ms-3">
                                            <a href="#" class="text-decoration-none {% if comment.is_liked_by_user %}text-danger{% else %}text-muted{% endif %}" onclick="event.preventDefault(); toggleCommentLike({{ comment.id }});">
                                                <i class="fas fa-heart me-1"></i><span id="comment-likes-count-{{ comment.id }}">{{ comment.likes_count }}</span>
                                            </a>
                                        </span>
                                    </div>
                                </div>
                            {% endfor %}
                            {% if comments|length == 0 %}
                                <p class="text-center text-muted">目前沒有評論。</p>
                            {% endif %}

                            {% else %}
                                <p class="text-center text-muted">目前沒有評論。</p>
                            {% endif %}
                        </div>


                        <div class="card-body">
                            {% if user.is_authenticated %}
                            <form method="post" action="{% url 'dream_post_detail' dream.id %}" class="mb-4">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <textarea name="comment" class="form-control" rows="3" placeholder="留下你的評論..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">提交評論</button>
                            </form>
                            {% else %}
                            <p class="text-center text-muted">登入後才能發表評論。</p>
                            {% endif %}
                        </div>

                    </div>


                   <!-- 評論分頁 -->
                    {% if comments.has_other_pages %}
                    <nav aria-label="Comments pagination" class="mt-3">
                        <ul class="pagination justify-content-center">

                            <!-- 上一頁 -->
                            {% if comments.has_previous %}
                                <li class="page-item">
                                    <a class="page-link page-gradient" href="?page={{ comments.previous_page_number }}">&laquo;</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                            {% endif %}

                            <!-- 頁碼範圍 -->
                            {% for num in comments.paginator.page_range %}
                                {% if num == comments.number %}
                                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                                {% elif num >= comments.number|add:'-2' and num <= comments.number|add:'2' %}
                                    <li class="page-item">
                                        <a class="page-link page-gradient" href="?page={{ num }}">{{ num }}</a>
                                    </li>
                                {% elif num == 1 or num == comments.paginator.num_pages %}
                                    <li class="page-item">
                                        <a class="page-link page-gradient" href="?page={{ num }}">{{ num }}</a>
                                    </li>
                                {% elif num == comments.number|add:'-3' or num == comments.number|add:'3' %}
                                    <li class="page-item disabled"><span class="page-link">…</span></li>
                                {% endif %}
                            {% endfor %}

                            <!-- 下一頁 -->
                            {% if comments.has_next %}
                                <li class="page-item">
                                    <a class="page-link page-gradient" href="?page={{ comments.next_page_number }}">&raquo;</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                            {% endif %}

                        </ul>
                    </nav>
                    {% endif %}

                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>相關夢境</h5>
                        </div>
                        <div class="card-body">
                            {% if similar_dreams %}
                                <ul class="list-group list-group-flush">
                                    {% for s_dream in similar_dreams %}
                                        <li class="list-group-item">
                                            <a href="{% url 'dream_post_detail' s_dream.id %}" class="text-decoration-none text-primary">{{ s_dream.title|truncatechars:30 }}</a>
                                            <small class="d-block text-muted">{{ s_dream.created_at|date:"Y-m-d" }}</small>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-center text-muted">目前沒有相關夢境。</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleCommentLike(commentId) {
        fetch(`/comment/${commentId}/like_toggle/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const likesCountSpan = document.getElementById(`comment-likes-count-${commentId}`);
                if (likesCountSpan) {
                    likesCountSpan.textContent = data.likes_count;
                }
                const likeLink = likesCountSpan.closest('a');
                if (data.liked) {
                    likeLink.classList.remove('text-muted');
                    likeLink.classList.add('text-danger');
                } else {
                    likeLink.classList.remove('text-danger');
                    likeLink.classList.add('text-muted');
                }
            } else {
                alert(data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function togglePostLike(postId) {
        fetch(`/post/${postId}/like_toggle/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const likesCountSpan = document.getElementById(`post-likes-count-${postId}`);
                if (likesCountSpan) {
                    likesCountSpan.textContent = data.likes_count;
                }
                const likeLink = likesCountSpan.closest('a');
                if (data.liked) {
                    likeLink.classList.remove('text-muted');
                    likeLink.classList.add('text-danger');
                } else {
                    likeLink.classList.remove('text-danger');
                    likeLink.classList.add('text-muted');
                }
            } else {
                alert(data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>


<!-- 放在 body 底部 -->
<div id="user-popover-card" class="card shadow rounded-4 position-absolute d-none" style="width: 250px; z-index: 1050;"></div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const popover = document.getElementById("user-popover-card");

    document.querySelectorAll('.user-popover-trigger').forEach(trigger => {
        trigger.addEventListener('mouseenter', function (e) {
            const rect = this.getBoundingClientRect();
            const username = this.dataset.username;
            const avatarUrl = this.dataset.avatarUrl;
            const title = this.dataset.displayTitle;
            const badgeIcon = this.dataset.displayBadgeIcon;
            const bio = this.dataset.bio;
            const specialties = this.dataset.specialties;
            const profileUrl = this.href;

            let avatarHtml = '';
            if (avatarUrl && !avatarUrl.includes('default_avatar.png')) {
                avatarHtml = `<img src="${avatarUrl}" class="rounded-circle me-2" width="50" height="50" style="object-fit: cover;">`;
            } else {
                const initial = username ? username.charAt(0).toUpperCase() : '?';
                avatarHtml = `
                    <div class="rounded-circle me-2 d-flex justify-content-center align-items-center shadow"
                        style="width: 50px; height: 50px; background: linear-gradient(135deg, #b790f5, #55b1fc); color: white; font-weight: 600; font-size: 20px; border: 2px solid #dee2e6;">
                        ${initial}
                    </div>`;
            }

            popover.innerHTML = `
                <div class="card-body p-3">
                    <div class="d-flex align-items-center mb-2">
                        ${avatarHtml}
                        <div>
                            <strong>${username}</strong>
                            ${badgeIcon ? `<i class="${badgeIcon} ms-1" title="徽章"></i>` : ''}
                            ${title ? `<div class="text-muted small">${title}</div>` : ''}
                        </div>
                    </div>
                    ${bio ?`<div class="mb-1"><strong>個人簡介：</strong> ${bio}</div>` : ''}
                    ${specialties ? `<div class="text-muted small"><strong>專長：</strong>${specialties}</div>` : ''}
                </div>
            `;


            popover.classList.remove('d-none');
            popover.style.top = (rect.bottom + window.scrollY - 200) + 'px';
            popover.style.left = (rect.right + window.scrollX + 5) + 'px';
        });

        trigger.addEventListener('mouseleave', function () {
            setTimeout(() => {
                popover.classList.add('d-none');
            }, 300); // 延遲避免滑到卡片瞬間消失
        });
    });

    popover.addEventListener('mouseenter', () => {
        clearTimeout(hideTimeout);
    });
    popover.addEventListener('mouseleave', () => {
        popover.classList.add('d-none');
    });
});
</script>


{% endblock %}