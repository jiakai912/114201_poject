{% extends 'dreams/base.html' %}
{% load static %}

{% block title %} - 夢境儀表板{% endblock %}

{% block content %}

<style>
    body { background-color: #F5F7FA; color: #2c3e50; font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif; }
    .page-container { background-color: #FFF; border-radius: 1.5rem; padding: 3rem; box-shadow: 0 8px 30px rgba(52, 152, 219, 0.15); border: 1px solid #D9E3F0; }
    .page-header h1 { text-align: center; margin-bottom: 0.5rem; color: #000; }
    .page-header p { text-align: center; font-style: italic; color: #7f8c8d; }

    .dashboard-card { background-color: #FFF; border: 1px solid #EAEFF5; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: all 0.3s; }
    .dashboard-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 10px 25px rgba(52, 152, 219, 0.2); border-color: #A9CCE3; }

    .btn-outline-info-glow { color: #3498DB; border-color: #3498DB; background-color: transparent; transition: all 0.3s; box-shadow: 0 0 8px rgba(52, 152, 219, 0.4); }
    .btn-outline-info-glow:hover { color: #FFF; background-color: #3498DB; border-color: #3498DB; box-shadow: 0 0 15px rgba(52, 152, 219, 0.6); transform: translateY(-2px); }

    .circular-progress-container { position: relative; width: 150px; height: 150px; margin: 1rem auto; }
    .circular-progress-background, .circular-progress-fill { position: absolute; width: 100%; height: 100%; border-radius: 50%; }
    .circular-progress-background { border: 10px solid #EAF2F8; }
    .circular-progress-fill { border: 10px solid transparent; border-top-color: #8E44AD; border-right-color: #3498DB; border-bottom-color: #8E44AD; border-left-color: #3498DB; transform: rotate(45deg); animation: rotateProgress 5s infinite linear; }
    .circular-progress-value { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; font-weight: bold; color: #3498DB; }
    @keyframes rotateProgress { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>

<div class="page-header">
    <div class="dream-icon"><i class="fas fa-chart-line"></i></div>
    <h1 class="fw-bold">夢境分析數據</h1>
    <p class="text-muted">回顧您過去的夢境分析數據</p>
</div>

<!-- 單一切換按鈕 -->
<div class="mb-4 text-end">
    <button id="toggleDashboardBtn" class="btn btn-primary">
        <i class="fas fa-exchange-alt"></i> <!-- 可換成任何你喜歡的 FontAwesome 圖示 -->
    </button>
</div>


<!-- 夢境歷史 -->
<div id="history-pane">
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="dashboard-card">
                <h5 class="card-title">個人關鍵字紀錄</h5>
                <canvas id="keywordBarChart" style="max-height:400px;"></canvas>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="dashboard-card">
                <h5 class="card-title">快樂情緒趨勢圖</h5>
                <canvas id="happyChart" style="max-height:400px;"></canvas>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="dashboard-card">
                <h5 class="card-title">焦慮情緒趨勢圖</h5>
                <canvas id="anxietyChart" style="max-height:400px;"></canvas>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="dashboard-card">
                <h5 class="card-title">恐懼情緒趨勢圖</h5>
                <canvas id="fearChart" style="max-height:400px;"></canvas>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="dashboard-card">
                <h5 class="card-title">興奮情緒趨勢圖</h5>
                <canvas id="excitedChart" style="max-height:400px;"></canvas>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="dashboard-card">
                <h5 class="card-title">悲傷情緒趨勢圖</h5>
                <canvas id="sadChart" style="max-height:400px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- 情緒儀表板 -->
<div id="emotion-pane" style="display:none;">
    <div class="row g-4">
        <!-- 左邊：最新夢境情緒 -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-body d-flex flex-column">
                    <!-- 標題 -->
                    <h5 class="card-title text-start mb-4">
                        <i class="fas fa-satellite-dish me-2"></i>最新夢境情緒感測
                    </h5>

                    <!-- 主體區塊：進度條 + 文字 -->
                    <div class="d-flex align-items-center gap-4 flex-grow-1" style="height: 100%;">
                        <!-- 左邊圓形進度條 -->
                        <div class="circular-progress-container" style="width: 160px; height: 160px; min-width: 160px;">
                            <div class="circular-progress-background"></div>
                            {% if latest_dream %}
                            <div class="circular-progress-fill"></div>
                            {% endif %}
                            <div class="circular-progress-value" style="font-size: 2rem;">{{ primary_emotion_value|floatformat:0 }}%</div>
                        </div>

                        <!-- 右邊文字區 -->
                        <div class="text-start flex-grow-1 d-flex flex-column justify-content-center">
                            <h3 class="current-emotion mb-2" style="font-size: 1.8rem;">{{ primary_emotion_name }}</h3>
                            <p class="emotion-description mb-3" style="font-size: 1.1rem;">{{ primary_emotion_description }}</p>
                            {% if latest_dream %}
                            <a href="{% url 'dream_detail' latest_dream.id %}" class="btn btn-outline-info-glow">查看該夢境詳情</a>
                            {% else %}
                            <a href="{% url 'dream_form' %}" class="btn btn-outline-info-glow">開始解析夢境</a>
                            {% endif %}
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- 右邊：個人關鍵字 -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">個人關鍵字紀錄</h5>
                    <canvas id="keywordBarChart2" style="max-height: 400px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="dashboard-card">
                <h5 class="card-title">情緒總覽</h5>
                <canvas id="emotionChart" style="max-height:400px;"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const btn = document.getElementById("toggleDashboardBtn");
    const historyPane = document.getElementById("history-pane");
    const emotionPane = document.getElementById("emotion-pane");

    btn.addEventListener("click", () => {
        const showingHistory = historyPane.style.display !== "none";
        historyPane.style.display = showingHistory ? "none" : "block";
        emotionPane.style.display = showingHistory ? "block" : "none";
        
        btn.classList.toggle("rotated"); // CSS 可以定義旋轉效果
    });


    // 載入情緒資料
    fetch("/api/emotion-data/").then(r=>r.json()).then(data=>{
        const createLineChart = (id, labels, dataset, label) => {
            new Chart(document.getElementById(id), {
                type: "line",
                data: { labels, datasets:[{ ...dataset, label, borderWidth:2 }] },
                options: { responsive:true, scales:{ y:{ beginAtZero:true, max:100 } } }
            });
        };

        createLineChart("happyChart", data.labels, data.datasets[0], "快樂");
        createLineChart("anxietyChart", data.labels, data.datasets[1], "焦慮");
        createLineChart("fearChart", data.labels, data.datasets[2], "恐懼");
        createLineChart("excitedChart", data.labels, data.datasets[3], "興奮");
        createLineChart("sadChart", data.labels, data.datasets[4], "悲傷");

        new Chart(document.getElementById('emotionChart'), {
            type: 'line',
            data: { labels: data.labels, datasets: data.datasets.map(ds=>({...ds,tension:0.3})) },
            options: { responsive:true }
        });
    });

    // 個人關鍵字
    fetch("/api/user-keywords/").then(r=>r.json()).then(keywordData=>{
        const createBarChart = id => {
            new Chart(document.getElementById(id), {
                type:'bar',
                data:{ labels: keywordData.map(i=>i.keyword), datasets:[{ label:"關鍵字頻率", data:keywordData.map(i=>i.count), backgroundColor:"rgba(106,90,205,0.2)", borderColor:"rgba(106,90,205,1)", borderWidth:1 }]},
                options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
            });
        };
        createBarChart("keywordBarChart");
        createBarChart("keywordBarChart2");
    });

});
</script>

{% endblock %}
