{% extends 'dreams/base.html' %}
{% load static %}

{% block title %} - 情緒儀表板{% endblock %}

{% block content %}
<style>
    /* --- 淺色科幻風佈景主題 --- */
    body {
        background-color: #F5F7FA;
        color: #2c3e50;
        font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    }
    .page-container {
        background-color: #FFFFFF;
        border-radius: 1.5rem;
        padding: 3rem;
        box-shadow: 0 8px 30px rgba(52, 152, 219, 0.15);
        border: 1px solid #D9E3F0;
        position: relative;
        overflow: hidden;
    }

    /* Header */
    .page-header h1.analysis-title {
        color: #000; /* 黑色，避免和藍色衝突 */
        font-weight: 700;
        text-align: center;
        margin-bottom: 0.5rem;
    }
    .page-header p { 
        color: #7f8c8d; 
        font-style: italic; 
        text-align: center;
    }

    /* 卡片樣式 */
    .dashboard-card {
        background-color: #FFFFFF;
        border: 1px solid #EAEFF5;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease-in-out;
        margin-bottom: 1.5rem;
    }
    .dashboard-card:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 10px 25px rgba(52, 152, 219, 0.2);
        border-color: #A9CCE3;
    }
    .dashboard-card .card-title {
        font-weight: 600;
        border-bottom: 1px solid #EAEFF5;
        padding-bottom: 0.75rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }
    .dashboard-card .card-title i { 
        margin-right: 0.75rem; 
        color: #8E44AD; 
    }
    .dashboard-card .card-text { 
        color: #34495e; 
        line-height: 1.8; 
    }

    /* 按鈕 */
    .btn-outline-info-glow {
        color: #3498DB;
        border-color: #3498DB;
        background-color: transparent;
        transition: all 0.3s ease-in-out;
        box-shadow: 0 0 8px rgba(52, 152, 219, 0.4);
    }
    .btn-outline-info-glow:hover {
        color: #FFFFFF;
        background-color: #3498DB;
        border-color: #3498DB;
        box-shadow: 0 0 15px rgba(52, 152, 219, 0.6);
        transform: translateY(-2px);
    }

    /* 情緒顯示區 */
    .emotion-display {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 350px;
        background-color: #F8F9FA;
        border: 2px dashed #A9CCE3;
        border-radius: 1rem;
        padding: 2rem;
        text-align: center;
        box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.05);
    }
    .emotion-display .current-emotion { 
        font-size: 3rem; 
        font-weight: bold; 
        color: #8E44AD; 
        margin-bottom: 1rem; 
    }
    .emotion-display .emotion-description { 
        color: #566573; 
        font-size: 1.1rem; 
    }

    /* 圓形進度條 */
    .circular-progress-container { 
        position: relative; 
        width: 150px; 
        height: 150px; 
        margin: 1rem auto; 
    }
    .circular-progress-background, .circular-progress-fill { 
        position: absolute; 
        width: 100%; 
        height: 100%; 
        border-radius: 50%; 
    }
    .circular-progress-background { 
        border: 10px solid #EAF2F8; 
    }
    .circular-progress-fill {
        border: 10px solid transparent;
        border-top-color: #8E44AD;
        border-right-color: #3498DB;
        border-bottom-color: #8E44AD;
        border-left-color: #3498DB;
        transform: rotate(45deg);
        animation: rotateProgress 5s infinite linear;
    }
    .circular-progress-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        font-weight: bold;
        color: #3498DB;
    }
    @keyframes rotateProgress { 
        from { transform: rotate(0deg); } 
        to { transform: rotate(360deg); } 
    }

    /* 圖表容器 */
    .chart-container {
        background-color: #FFFFFF;
        border-radius: 1.5rem;
        padding: 2rem;
        box-shadow: 0 8px 30px rgba(52, 152, 219, 0.15);
        border: 1px solid #D9E3F0;
        margin-top: 3rem;
    }
    .chart-canvas { width: 100%; max-height: 450px; }

    /* 動畫 */
    .fade-in { opacity: 0; animation: fadeIn 1s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* 分頁標籤 */
    .nav-tabs .nav-link { color: #566573; }
    .nav-tabs .nav-link.active {
        color: #3498DB;
        font-weight: bold;
        border-color: #dee2e6 #dee2e6 #fff;
    }
</style>

<div class="page-header">
    <div class="dream-icon">
        <i class="fas fa-chart-line"></i>
    </div>
    <h1 class="fw-bold">夢境分析數據</h1>
    <p class="text-muted">回顧您過去的夢境分析數據</p>
</div>



        <div class="row g-4">
            <!-- 左邊 -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-body d-flex flex-column">
                        <!-- 標題 -->
                        <h5 class="card-title text-start mb-4">
                            <i class="fas fa-satellite-dish me-2"></i>最新夢境情緒感測
                        </h5>

                        <!-- 主體區塊：進度條 + 文字 -->
                        <div class="d-flex align-items-center gap-4 flex-grow-1" style="height: 100%;">
                            <!-- 左邊圓形進度條 -->
                            <div class="circular-progress-container" style="width: 160px; height: 160px; min-width: 160px;">
                                <div class="circular-progress-background"></div>
                                {% if latest_dream %}
                                <div class="circular-progress-fill"></div>
                                {% endif %}
                                <div class="circular-progress-value" style="font-size: 2rem;">{{ primary_emotion_value|floatformat:0 }}%</div>
                            </div>

                            <!-- 右邊文字區 -->
                            <div class="text-start flex-grow-1 d-flex flex-column justify-content-center">
                                <h3 class="current-emotion mb-2" style="font-size: 1.8rem;">{{ primary_emotion_name }}</h3>
                                <p class="emotion-description mb-3" style="font-size: 1.1rem;">{{ primary_emotion_description }}</p>
                                {% if latest_dream %}
                                <a href="{% url 'dream_detail' latest_dream.id %}" class="btn btn-outline-info-glow">查看該夢境詳情</a>
                                {% else %}
                                <a href="{% url 'dream_form' %}" class="btn btn-outline-info-glow">開始解析夢境</a>
                                {% endif %}
                            </div>
                        </div>

                    </div>
                </div>
            </div>



            <!-- 右邊 -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">個人關鍵字紀錄</h5>
                        <canvas id="keywordBarChart" style="max-height: 400px;"></canvas>
                    </div>
                </div>
            </div>


            <!-- 下方情緒頻譜分析圖 -->
            <div class="container chart-container fade-in">
                <ul class="nav nav-tabs" id="emotionTab" role="tablist">
                    <li class="nav-item"><button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview-pane" type="button" role="tab">情緒總覽</button></li>
                    <li class="nav-item"><button class="nav-link" id="happy-tab" data-bs-toggle="tab" data-bs-target="#happy-pane" type="button" role="tab">快樂</button></li>
                    <li class="nav-item"><button class="nav-link" id="anxiety-tab" data-bs-toggle="tab" data-bs-target="#anxiety-pane" type="button" role="tab">焦慮</button></li>
                    <li class="nav-item"><button class="nav-link" id="fear-tab" data-bs-toggle="tab" data-bs-target="#fear-pane" type="button" role="tab">恐懼</button></li>
                    <li class="nav-item"><button class="nav-link" id="excited-tab" data-bs-toggle="tab" data-bs-target="#excited-pane" type="button" role="tab">興奮</button></li>
                    <li class="nav-item"><button class="nav-link" id="sad-tab" data-bs-toggle="tab" data-bs-target="#sad-pane" type="button" role="tab">悲傷</button></li>
                </ul>
                <div class="tab-content pt-4">
                    <div class="tab-pane fade show active" id="overview-pane"><canvas id="emotionChart" class="chart-canvas"></canvas></div>
                    <div class="tab-pane fade" id="happy-pane"><canvas id="happyChart" class="chart-canvas"></canvas></div>
                    <div class="tab-pane fade" id="anxiety-pane"><canvas id="anxietyChart" class="chart-canvas"></canvas></div>
                    <div class="tab-pane fade" id="fear-pane"><canvas id="fearChart" class="chart-canvas"></canvas></div>
                    <div class="tab-pane fade" id="excited-pane"><canvas id="excitedChart" class="chart-canvas"></canvas></div>
                    <div class="tab-pane fade" id="sad-pane"><canvas id="sadChart" class="chart-canvas"></canvas></div>
                </div>
            </div>
        </div>



<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/emotion-data/')
        .then(response => response.json())
        .then(data => {
            const chartOptions = (title) => ({
                responsive: true,
                plugins: { title: { display: true, text: title, font: { size: 16 } }, legend: { position: 'top' } },
                scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } }
            });

            // 總覽
            new Chart(document.getElementById('emotionChart'), {
                type: 'line',
                data: { labels: data.labels, datasets: data.datasets.map(ds => ({...ds, tension: 0.3})) },
                options: chartOptions('情緒綜合趨勢圖')
            });

            // 單獨圖表
            const createSingleChart = (id, ds) => {
                new Chart(document.getElementById(id), {
                    type: 'line',
                    data: { labels: data.labels, datasets: [{...ds, tension: 0.3, fill: true, backgroundColor: ds.borderColor.replace('1)', '0.2)')}] },
                    options: chartOptions(`${ds.label}趨勢圖`)
                });
            };
            createSingleChart('happyChart', data.datasets[0]);
            createSingleChart('anxietyChart', data.datasets[1]);
            createSingleChart('fearChart', data.datasets[2]);
            createSingleChart('excitedChart', data.datasets[3]);
            createSingleChart('sadChart', data.datasets[4]);
        });

    // 個人關鍵字
    fetch("/api/user-keywords/")
        .then(r => r.json())
        .then(keywordData => {
            new Chart(document.getElementById("keywordBarChart"), {
                type: "bar",
                data: {
                    labels: keywordData.map(item => item.keyword),
                    datasets: [{ label: "關鍵字頻率", data: keywordData.map(item => item.count), backgroundColor: "rgba(106, 90, 205, 0.2)", borderColor: "rgba(106, 90, 205, 1)", borderWidth: 1 }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        });
});
</script>
{% endblock %}
